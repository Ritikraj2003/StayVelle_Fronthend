<div class="add_services_container">

  <div class="d-flex align-items-center justify-content-between mb_40">
    <div>
      <h3 class="font_20 fw_semi text_black mb_2">Payment</h3>
      <span class="text_pri fw_med font_12 d-block">Check Out <span class="text_black">~ Payment</span></span>
    </div>
  </div>

  <!-- Error State -->
  <div *ngIf="error" class="alert alert-danger mb_24">
    <span class="font_14 fw_med">{{ error }}</span>
  </div>

  <!-- Main Content Grid -->
  <div *ngIf="bookingData" class="payment-grid-container">

    <!-- Left Column -->
    <div class="left-column">

      <!-- Room Charges Card -->
      <div class="payment-card mb_24">
        <div class="d-flex justify-content-between align-items-center mb_20 pb_20 border-bottom-light">
          <div class="d-flex align-items-center gap-2">
            <!-- <span class="material-icons text_pri">hotel</span> -->
            <img src="assets/images/hotel.png" alt="Hotel" class="icon-img">
            <h4 class="font_16 fw_bold text_black m-0">Room Charges</h4>
          </div>
          <span class="status-badge status-standard">Standard Rate</span>
        </div>

        <div class="row mb_20">
          <div class="col-md-4">
            <span class="font_11 fw_bold text_gray text-uppercase d-block mb_1">STAY DURATION</span>
            <span class="font_14 fw_semi text_black d-block">{{ calculateNights() }} Nights</span>
            <span class="font_12 fw_reg text_gray">{{ formatDate(bookingData.checkInDate) }} &rarr; {{
              formatDateWithYear(bookingData.checkOutDate) }}</span>
          </div>
          <div class="col-md-4">
            <span class="font_11 fw_bold text_gray text-uppercase d-block mb_1">BASE RATE</span>
            <div>
              <span class="font_14 fw_semi text_black">₹{{ bookingData.room?.price || 0 }}</span>
              <span class="font_12 fw_reg text_gray"> / night</span>
            </div>
          </div>
          <div class="col-md-4">
            <span class="font_11 fw_bold text_gray text-uppercase d-block mb_1">OCCUPANCY</span>
            <span class="font_14 fw_semi text_black">{{ bookingData.numberOfGuests }} Adults</span>
          </div>
        </div>

        <hr class="separator">

        <div class="d-flex justify-content-between align-items-center mt_20">
          <span class="font_14 fw_med text_gray">Room Subtotal</span>
          <span class="font_18 fw_bold text_black">₹{{ calculateRoomSubtotal() | number:'1.2-2' }}</span>
        </div>
      </div>

      <!-- Service List Card -->
      <div class="payment-card">
        <div class="d-flex align-items-center gap-2 mb_20">
          <!-- <span class="material-icons text_pri">restaurant</span> -->
          <img src="assets/images/service_icon.svg" alt="Service" class="icon-img">
          <h4 class="font_16 fw_bold text_black m-0">Service List</h4>
        </div>

        <div class="table-responsive service-list-scroll">
          <table class="table table-borderless service-table">
            <thead>
              <tr>
                <th scope="col" class="font_11 fw_bold text_gray text-uppercase opacity_5 pl-0">DATE</th>
                <th scope="col" class="font_11 fw_bold text_gray text-uppercase opacity_5">SERVICE</th>
                <th scope="col" class="font_11 fw_bold text_gray text-uppercase opacity_5">CATEGORY</th>
                <th scope="col" class="font_11 fw_bold text_gray text-uppercase opacity_5 text-right pr-0">PRICE</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let service of bookingData.bookingServices">
                <td class="font_13 fw_reg text_black pl-0">{{ getCurrentDateTime() }}</td>
                <!-- Using current date as placeholder if service date is missing -->
                <td class="font_13 fw_med text_black">{{ service.serviceName }} <span
                    class="text_gray font_12">({{service.quantity}} items)</span></td>
                <td>
                  <span class="category-badge">{{ service.serviceCategory }}</span>
                </td>
                <td class="font_13 fw_bold text_black text-right pr-0">₹{{ (service.price * service.quantity) |
                  number:'1.2-2' }}</td>
              </tr>
              <tr *ngIf="!bookingData.bookingServices || bookingData.bookingServices.length === 0">
                <td colspan="4" class="text-center font_13 text_gray py-4">No services added yet.</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="d-flex justify-content-between align-items-center mt_20 pt_20 border-top-light">
          <span class="font_13 fw_reg text_gray">{{ bookingData.bookingServices?.length || 0 }} items listed</span>
          <div class="d-flex align-items-center gap-2">
            <span class="font_14 fw_reg text_black">Services Subtotal</span>
            <span class="font_16 fw_bold text_black">₹{{ calculateServiceTotal() | number:'1.2-2' }}</span>
          </div>
        </div>
      </div>

    </div>

    <!-- Right Column -->
    <div class="right-column">

      <!-- Order Summary Card -->
      <div class="payment-card sticky-summary">
        <h4 class="font_16 fw_bold text_black mb_1">Order Summary</h4>
        <p class="font_12 fw_reg text_gray mb_24">Review items before finalizing payment</p>

        <div class="form-group mb_24">
          <label class="font_11 fw_bold text_gray text-uppercase mb_1">COUPON CODE</label>
          <div class="input-group">
            <input type="text" class="form-control coupon-input" placeholder="e.g. SUMMER20">
          </div>
        </div>

        <div class="summary-details mb_24">
          <div class="d-flex justify-content-between align-items-center mb_12">
            <span class="font_13 fw_med text_gray">Room Total</span>
            <span class="font_13 fw_med text_black">₹{{ calculateRoomSubtotal() | number:'1.2-2' }}</span>
          </div>
          <div class="d-flex justify-content-between align-items-center mb_12">
            <span class="font_13 fw_med text_gray">Service Charges</span>
            <span class="font_13 fw_med text_black">₹{{ calculateServiceTotal() | number:'1.2-2' }}</span>
          </div>
          <div class="d-flex justify-content-between align-items-center mb_12">
            <span class="font_13 fw_med text_gray">Taxes (18% GST)</span>
            <span class="font_13 fw_med text_black">₹{{ calculateTax() | number:'1.2-2' }}</span>
          </div>
          <div class="d-flex justify-content-between align-items-center mb_12">
            <span class="font_13 fw_med text_gray">Paid Amount</span>
            <span class="font_13 fw_med text_black">₹{{ calculatePaidAmount() | number:'1.2-2' }}</span>
          </div>
          <div class="d-flex justify-content-between align-items-center mb_12">
            <span class="font_13 fw_med text_green">Discount</span>
            <span class="font_13 fw_bold text_green">-₹0.00</span>
          </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb_24 total-section">
          <span class="font_12 fw_bold text_gray text-uppercase letter-spacing-1">TOTAL<br>AMOUNT DUE</span>
          <span class="font_24 fw_extra_bold text_pri">₹{{ calculateAmountDue() | number:'1.2-2' }}</span>
        </div>

        <div class="d-flex align-items-center gap-2 mb_12">
          <button class="btn btn-primary flex-grow-1 btn-payment" (click)="openPaymentModal()" [disabled]="isSaving">
            <!-- <span class="material-icons icon-sm mr-2" *ngIf="!isSaving">payments</span>  -->
            <img src="assets/images/payment_white_icon.svg" alt="" class="icon-img-sm mr-2" *ngIf="!isSaving">
            <span class="spinner-border spinner-border-sm mr-2" *ngIf="isSaving" role="status"
              aria-hidden="true"></span>
            {{ isSaving ? 'Processing...' : 'Process Payment' }}
          </button>

          <button class="btn btn-outline-secondary flex-grow-1 btn-save" (click)="cancel()">
            Cancel / Save for Later
          </button>
        </div>

        <div class="secure-badge mt_24 d-flex gap-2">
          <span class="material-icons text_gray font_16">verified_user</span>
          <span class="font_10 text_gray lh-sm">Secure checkout powered by StayVelle. All transactions are encrypted and
            logged.</span>
        </div>

      </div>
    </div>

  </div>

  <div *ngIf="!bookingData && !isLoading && !error" class="alert alert-info">
    No booking selected for payment.
  </div>
</div>

<!-- Process Payment Modal -->
<ng-template #paymentModalContent let-modal>
  <div class="modal-content payment-modal-content border-0 shadow-none w-100 m-0 p-0 overflow-hidden"
    style="border-radius: 12px;">

    <!-- Header -->
    <div class="modal-header bg_primary text-white d-flex justify-content-between align-items-center">
      <div>
        <h3 class="font_20 fw_bold text-white mb_1">Process Payment</h3>
        <span class="font_12 text-white opacity_8">Guest: {{ bookingData?.guests?.[0]?.guestName || 'N/A' }} • Room {{
          bookingData?.room?.roomNumber || 'N/A' }}</span>
      </div>
      <div class="text-right d-flex flex-column align-items-end">
        <span class="font_10 fw_bold text-white text-uppercase d-block mb_1 opacity_8">TOTAL AMOUNT TO PAY</span>
        <span class="font_24 fw_extra_bold text-white">₹{{ calculateAmountDue() | number:'1.2-2' }}</span>
      </div>
    </div>

    <!-- Body -->
    <div class="modal-body p_24 content-body-bg">
      <div class="row m-0">
        <!-- Left Column: Payment Methods -->
        <div class="col-md-5 col-sm-12 pl-0 pr-md-4 mb-4 mb-md-0">
          <span class="font_10 fw_bold text_gray text-uppercase d-block mb_16">SELECT PAYMENT METHOD</span>

          <!-- Razorpay Option -->
          <div class="payment-method-card mb_12" [class.active]="selectedPaymentMethod === 'Razorpay'"
            (click)="selectedPaymentMethod = 'Razorpay'">
            <div class="d-flex align-items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                [class.text_pri]="selectedPaymentMethod === 'Razorpay'"
                [class.text_gray]="selectedPaymentMethod !== 'Razorpay'" class="flex-shrink-0 current-color-svg">
                <path
                  d="M21 7.28V5c0-1.1-.9-2-2-2H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-2.28c.59-.35 1-.98 1-1.72V9c0-.74-.41-1.38-1-1.72zM20 9v6h-7V9h7zM5 19V5h14v2h-6c-1.1 0-2 .9-2 2v6c0 1.1.9 2 2 2h6v2H5z" />
                <circle cx="16" cy="12" r="1.5" />
              </svg>
              <div>
                <span class="font_14 fw_semi text_black d-block mb_1">Razorpay Online</span>
                <span class="font_10 fw_reg text-uppercase" [class.text_pri]="selectedPaymentMethod === 'Razorpay'"
                  [class.text_gray]="selectedPaymentMethod !== 'Razorpay'">UPI, CARD, NETBANKING</span>
              </div>
            </div>
          </div>

          <!-- Cash Payment Option -->
          <div class="payment-method-card" [class.active]="selectedPaymentMethod === 'Cash'"
            (click)="selectedPaymentMethod = 'Cash'">
            <div class="d-flex align-items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                [class.text_pri]="selectedPaymentMethod === 'Cash'" [class.text_gray]="selectedPaymentMethod !== 'Cash'"
                class="flex-shrink-0 current-color-svg">
                <path
                  d="M19 14V6c0-1.1-.9-2-2-2H3c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zm-2 0H3V6h14v8zm-7-7c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3zm13 0v11c0 1.1-.9 2-2 2H7v-2h14V7h2z" />
              </svg>
              <div>
                <span class="font_14 fw_semi text_black d-block mb_1">Cash Payment</span>
                <span class="font_10 fw_reg text-uppercase" [class.text_pri]="selectedPaymentMethod === 'Cash'"
                  [class.text_gray]="selectedPaymentMethod !== 'Cash'">MANUAL</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Column: Details -->
        <div class="col-md-7 border-left-light-md pl-md-4 pl-0 pr-0">

          <!-- Razorpay View -->
          <div *ngIf="selectedPaymentMethod === 'Razorpay'"
            class="payment-detail-view razorpay-view justify-content-center">
            <div
              class="secure-icon-wrapper mb_24 mx-auto bg-light-blue rounded-circle shadow-sm d-flex align-items-center justify-content-center"
              style="width: 80px; height: 80px;">
              <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24"
                class="text_pri current-color-svg">
                <path
                  d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z" />
              </svg>
            </div>
            <h4 class="font_20 fw_bold text_black text-center mb_16">Secure Checkout</h4>
            <p class="font_14 fw_reg text_gray text-center lh-base px-md-4 m-0">
              Upon clicking "Complete Payment", you will be redirected to the <span class="fw_bold text_black">Razorpay
                Secure Gateway</span> to complete your transaction via UPI, Cards, or Netbanking.
            </p>
          </div>

          <!-- Cash View -->
          <div *ngIf="selectedPaymentMethod === 'Cash'" class="payment-detail-view cash-view">
            <div class="d-flex align-items-center gap-3 mb_24">
              <div
                class="icon-bg-box rounded-circle shadow-sm bg-white d-flex align-items-center justify-content-center"
                style="width: 48px; height: 48px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                  class="text_pri current-color-svg">
                  <path d="M4 10h3v7H4zm6.5 0h3v7h-3zM2 19h20v3H2zm15-9h3v7h-3zm-5-9L2 6v2h20V6l-10-5z" />
                </svg>
              </div>
              <h4 class="font_16 fw_bold text_black m-0">Cash Received</h4>
            </div>

            <div class="form-group mb_20">
              <label class="font_10 fw_bold text_gray text-uppercase mb_2">AMOUNT RECEIVED (₹)</label>
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text bg-white border-right-0 text_gray fw_med font_14 px-3 py-2">₹</span>
                </div>
                <input type="number" class="form-control border-left-0 pl-0 fw_semi font_14 text_black py-2"
                  [(ngModel)]="amountReceived" style="height: auto;">
              </div>
            </div>

            <div class="form-group mb_24">
              <label class="font_10 fw_bold text_gray text-uppercase mb_2">INTERNAL REFERENCE / NOTES</label>
              <textarea class="form-control font_13 px-4 py-3" rows="3" placeholder="Receipt # or collection details..."
                [(ngModel)]="paymentNotes"></textarea>
            </div>

            <div class="secure-badge d-flex gap-3 align-items-start bg-light-blue p-3 mb-2 shadow-sm">
              <div class="bg_primary rounded-circle d-flex align-items-center justify-content-center flex-shrink-0"
                style="width: 24px; height: 24px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                  class="text-white current-color-svg">
                  <path
                    d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z" />
                </svg>
              </div>
              <p class="font_12 text_black m-0 lh-base">This payment will be recorded as a <span
                  class="fw_semi text_pri text-decoration-underline">manual transaction</span>. Please ensure cash is
                secured.</p>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="modal-footer flex-column p_24 pt_0 border-top-0 content-body-bg rounded-bottom">
      <button
        class="btn btn-primary btn-block btn-payment mb_12 d-flex align-items-center justify-content-center gap-2 w-100"
        (click)="processPayment()" [disabled]="isSaving">
        <svg *ngIf="!isSaving" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
          class="text-white current-color-svg">
          <path
            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
        </svg>
        <span class="spinner-border spinner-border-sm" *ngIf="isSaving" role="status" aria-hidden="true"></span>
        <span class="font_15 fw_semi text-white">{{ isSaving ? 'Processing...' : 'Complete Payment' }}</span>
      </button>
      <button class="btn btn-link text_gray font_12 fw_semi text-uppercase text-decoration-none p-0 mt-2"
        (click)="closePaymentModal()">Cancel and Return</button>
    </div>

  </div>
</ng-template>